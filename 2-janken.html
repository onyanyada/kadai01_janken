<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script src="js/jquery-2.1.3.min.js"></script>
    <link rel="stylesheet" href="css/sample.css">
    <title>タイマーじゃんけん</title>
    <!-- 紙吹雪 -->
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.3.2/dist/confetti.browser.min.js"></script>
    <!-- Google Chartsのライブラリ -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>


</head>

<body>

    <header>
        <h1>タイマーじゃんけん</h1>
    </header>

    <main>
        <div id="particles-js">
            <div id="wrapper">
                <div class="timer">
                    <p>時間を決めてじゃんけんする</p>
                    <input id="sec" type="text">
                    <button id="start">開始</button>

                    <p id="time"></p>
                </div>

                <div class="jankenGame">
                    <div id="janken">
                        <p>あなたの出す手は？</p>
                        <ul>
                            <li id="gu_btn" class="option"><img src="./img/gu.png" alt="" width="100px"></li>
                            <li id="cho_btn" class="option"><img src="./img/choki.png" alt="" width="100px"></li>
                            <li id="par_btn" class="option"><img src="./img/pa.png" alt="" width="100px"></li>
                        </ul>
                        <p>コンピュータの出した手は？</p>
                        <div><span id="pc_hands"></span></div>
                    </div>
                    <div id="result-list">
                        <p id="judgment"></p>
                        <p id="score"></p>
                        <p class="total inner-result"></p>
                        <p class="total outer-result"></p>
                        <p class="often"></p>
                        <p class="average"></p>
                        <p class="win"></p>
                        <p class="lose"></p>
                        <p class="even"></p>
                        <p class="winRate"></p>
                    </div>
                    <div class="chart">
                        <div id="chart_div"></div>
                    </div>
                    <div class="pie-chart">
                        <div id="pie_chart_div"></div>
                    </div>
                </div>
                <p class="total outer-result"></p>
                <button class="repeat"><a href="timer-janken.html">もう一回やる</a></button>
            </div>
        </div>
    </main>

    <footer><button><a href="index.html">トップに戻る</a></button></footer>
    <script>
        // タイマーここから
        const time = document.querySelector("#time");
        const sec = document.querySelector("#sec");
        let count = 0;

        $('#start').click(function () {

            const set_id = setInterval(function () {
                count++;
                time.innerHTML = count;
                if (count == sec.value) {
                    $(".jankenGame").hide();
                    $('.timer').hide();
                    $('.outer-result').show();
                    $('.repeat').show();
                    clearInterval(set_id);
                }

            }, 1000);

        });
        // タイマーここまで



        // じゃんけんここから  
        let total = 0;// 勝敗合計点数
        let hand = "";//変数用意
        let judge = ""; //変数用意
        let score = 0; //変数用意：点数
        let often = 0;//変数用意：回数
        let average = 0; //変数用意：平均点
        let win = 0;//勝った回数
        let lose = 0;//負けた回数
        let even = 0;//あいこ回数
        let guWin = 0;//グーで買った回数
        let choWin = 0;//チョキで買った回数
        let paWin = 0;//パーで買った回数
        let winRate = 0;//勝率

        // グーを選んだ時
        $("#gu_btn").on("click", function () {
            const r = Math.ceil(Math.random() * 3);//1.乱数(1~3)


            //2.if分岐処理

            if (r == 1) {
                hand = '<img src="./img/gu.png" width="100px">';
                judge = 'あいこ';
                score = 0;
                even += 1;

            }
            if (r == 2) {
                hand = '<img src="./img/choki.png" width="100px">';
                judge = '勝ち';
                score = 1;
                win += 1;
                guWin += 1;
                // 紙吹雪
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
            if (r == 3) {
                hand = '<img src="./img/pa.png" width="100px">';
                judge = '負け';
                score = -1;
                lose += 1;
            }

            // 計算
            jankenCalc();

            //3.表示処理
            jankenView();
        });

        // チョキを選んだ時
        $("#cho_btn").on("click", function () {
            const r = Math.ceil(Math.random() * 3);//1.乱数(1~3)

            //2.if分岐処理
            if (r == 1) {
                hand = '<img src="./img/gu.png" width="100px">';
                judge = '負け';
                score = -1;
                lose += 1;
            }
            if (r == 2) {
                hand = '<img src="./img/choki.png" width="100px">';
                judge = 'あいこ';
                score = 0;
                even += 1;
            }
            if (r == 3) {
                hand = '<img src="./img/pa.png" width="100px">';
                judge = '勝ち';
                score = 1;
                win += 1;
                // 紙吹雪
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });

            }

            // 計算
            jankenCalc();
            //3.表示処理
            jankenView();
        });

        // パーを選んだ時
        $("#par_btn").on("click", function () {
            const r = Math.ceil(Math.random() * 3);//1.乱数(1~3)
            //2.if分岐処理
            if (r == 1) {
                hand = '<img src="./img/gu.png" width="100px">';
                judge = '勝ち';
                score = 1;
                win += 1;
                // 紙吹雪
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
            if (r == 2) {
                hand = '<img src="./img/choki.png" width="100px">';
                judge = '負け';
                score = -1;
                lose += 1;
            }
            if (r == 3) {
                hand = '<img src="./img/pa.png" width="100px">';
                judge = 'あいこ';
                score = 0;
                even += 1;
            }

            // 計算
            jankenCalc();

            //3.表示処理
            jankenView();
        });

        //計算
        const jankenCalc = () => {
            often++;
            total += score;
            average = Math.floor((total / often) * 10) / 10;
            winRate = Math.floor((win / (win + lose)) * 10) / 10;
        }

        //3.表示処理
        // const jankenView = () => {
        //     $("#pc_hands").html(hand);
        //     $("#judgment").html(judge);
        //     $("#score").html(score);
        //     $(".total").text(total);
        //     $(".often").html(often);
        //     $(".average").html(average);
        //     $(".win").html(win);
        //     $(".lose").html(lose);
        //     $(".even").html(even);
        //     $(".winRate").html(winRate);
        //     updateChart(score);
        //     updatePieChart();
        // }
        //じゃんけんここまで



        // 折れ線チャートここから
        google.charts.load('current', { 'packages': ['corechart'] });
        google.charts.setOnLoadCallback(initCharts);

        function initCharts() {
            initLineChart();
            drawPieChart();
        }
        // グローバル変数
        let lineChart, lineData, lineOptions, pieChart, pieData, pieOptions;
        let counts = 0; // 回数カウント用変数

        // 折れ線チャートの初期化
        function initLineChart() {
            lineData = google.visualization.arrayToDataTable([
                ['Count', 'Score'],
                [0, 0]
            ]);

            lineOptions = {
                title: 'n回目のじゃんけんの点数',
                curveType: 'function',
                legend: { position: 'bottom' },
                hAxis: {
                    title: 'n回目'
                },
                vAxis: {
                    title: '点数'
                }
            };

            lineChart = new google.visualization.LineChart(document.getElementById('chart_div'));
            lineChart.draw(lineData, lineOptions);
        }

        // 折れ線チャートの更新
        function updateLineChart(score) {
            counts++;
            lineData.addRow([counts, score]);
            lineChart.draw(lineData, lineOptions);
        }

        // 円グラフの初期化
        function drawPieChart() {
            pieData = google.visualization.arrayToDataTable([
                ['勝った手', '勝った回数'],
                ['グー', 0],
                ['チョキ', 0],
                ['パー', 0],
            ]);

            pieOptions = {
                chartArea: {
                    left: 20,
                    right: 20,
                    top: 20,
                    bottom: 20,
                    width: '100%',
                },
                legend: {
                    alignment: 'center',
                },
                tooltip: {
                    text: 'both',
                    textStyle: {
                        fontSize: 20,
                    },
                    showColorCode: 'true',
                },
            };

            pieChart = new google.visualization.PieChart(document.getElementById('pie_chart_div'));
            pieChart.draw(pieData, pieOptions);
        }

        // 円グラフの更新
        function updatePieChart(guWin, choWin, paWin) {
            pieData = google.visualization.arrayToDataTable([
                ['勝った手', '勝った回数'],
                ['グー', guWin],
                ['チョキ', choWin],
                ['パー', paWin],
            ]);
            pieChart.draw(pieData, pieOptions);
        }

        // じゃんけんの結果表示処理
        const jankenView = () => {
            $("#pc_hands").html(hand);
            $("#judgment").html(judge);
            $("#score").html(score);
            $(".total").text(total);
            $(".often").html(often);
            $(".average").html(average);
            $(".win").html(win);
            $(".lose").html(lose);
            $(".even").html(even);
            $(".winRate").html(winRate);
            updateLineChart(score);
            updatePieChart();
        }




        // マーカー
        window.addEventListener('load', function () {
            const height = window.innerHeight;                    //画面の高さを取得
            const scroll = this.pageYOffset;                      //スクロール量
            const marker = document.querySelectorAll('h1');  //マーカーを引く要素を取得
            const value = scroll - height + 300                   //後ろの数字を弄ることで、イベント位置をずらす

            // markerクラスを持っている要素全てに処理を行う
            marker.forEach(function (element) {
                //要素が画面内の指定の位置に来たら「on」クラスをつける
                if (scroll > element.getBoundingClientRect().top + value) {
                    element.classList.add('on')
                }
            });
        })


    </script>
</body>

</html>